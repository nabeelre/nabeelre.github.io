<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-ZM95CLY1K3"
        ></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());
            gtag("config", "G-ZM95CLY1K3", {
                "anonymize_ip": true
            });
        </script>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />
        <meta name="description" content="Visualization - Nabeel Rehemtulla" />
        <meta name="author" content="Nabeel Rehemtulla" />
        <title>Visualization - Nabeel Rehemtulla</title>
        <!-- Font Awesome icons (free version)-->
        <script
            src="https://use.fontawesome.com/releases/v5.15.1/js/all.js"
            crossorigin="anonymous"
        ></script>
        <!-- Google fonts-->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <!-- Core theme CSS-->
        <link href="css/styles.css" rel="stylesheet" />
        <!-- Import map to resolve ES module dependencies -->
        <script type="importmap">
        {
            "imports": {
                "apache-arrow": "https://esm.sh/apache-arrow@14.0.1"
            },
            "scopes": {
                "https://esm.sh/": {
                    "apache-arrow": "https://esm.sh/apache-arrow@14.0.1"
                },
                "https://cdn.jsdelivr.net/": {
                    "apache-arrow": "https://esm.sh/apache-arrow@14.0.1"
                }
            }
        }
        </script>
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar">
            <div class="nav-container">
                <a href="index.html" class="nav-logo">Nabeel Rehemtulla</a>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">About</a>
                    </li>
                    <li class="nav-item">
                        <a href="research.html" class="nav-link">Research</a>
                    </li>
                    <li class="nav-item">
                        <a href="visualization.html" class="nav-link active">Visualization</a>
                    </li>
                    <li class="nav-item">
                        <a href="assets/docs/NR_CV.pdf" target="_blank" class="nav-link">CV</a>
                    </li>
                </ul>
                <div class="nav-toggle" id="mobile-menu">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </div>
        </nav>

        <!-- Visualization Section -->
        <section class="page-section">
            <div class="container visualization-content">
                <h1>Visualization</h1>
                <p class="section-intro">
                    I'm passionate about creating exciting and effective visualizations to disseminate my work. 
                    Here are two examples of such efforts:
                </p>
                <div class="video-card">
                    <div class="video-wrapper">
                        <iframe
                            src="https://www.youtube-nocookie.com/embed/qUwlQflDdEo?si=AdulxxXQlIuAoBlf"
                            title="YouTube video player"
                            width="560"
                            height="315"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            referrerpolicy="strict-origin-when-cross-origin"
                            allowfullscreen
                            loading="lazy"
                        ></iframe>
                    </div>
                    <p class="video-caption">
                        I created this animation for a visualization competition at a Northwestern Computational Science Symposium where it
                        was awarded first prize. 
                        It captures for a general audience how supernova discovery and classification workflows function
                        and highlights how my BTSbot model enabled the world's first fully automated discovery and classification of a supernova.
                    </p>
                </div>

                <div class="atlas-card">
                    <div class="atlas-card-text">
                        <h2>BTSbot Embedding Atlas</h2>
                        <p>
                            The interactive panel below shows a 2-D view of BTSbot's learned representation of input ZTF data. 
                            You can pan, zoom, filter, and inspect individual sources to help understand what BTSbot is doing. 
                        </p>
                        <p class="atlas-tip">Note: the interactive panel does not function on the Safari browser but should work well on other browsers.</p>
                        <div id="embedding-atlas-status" class="atlas-status" role="status" aria-live="polite">
                            Initializing Embedding Atlas…
                        </div>
                    </div>
                    <div id="embedding-atlas-root" class="atlas-view" aria-label="Interactive embedding atlas workspace"></div>
                    <noscript class="atlas-noscript">
                        JavaScript is disabled, so the interactive Embedding Atlas cannot be displayed. Enable JavaScript to explore the embeddings.
                    </noscript>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <p>&copy; <span id="current-year"></span> Nabeel Rehemtulla</p>
            </div>
        </footer>

        <!-- Bootstrap core JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
        <script type="module">
            const atlasRoot = document.getElementById("embedding-atlas-root");
            const atlasStatus = document.getElementById("embedding-atlas-status");
            const DATA_FILE = "maxvit_gz_emb.csv";
            const CSV_URL = new URL(`./assets/dat/${DATA_FILE}`, window.location.href);
            const DUCKDB_VERSION = "1.30.0";

            async function createDuckDB() {
                const duckdb = await import(
                    `https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@${DUCKDB_VERSION}/dist/duckdb-browser.mjs`
                );

                // Use absolute paths from root to ensure same-origin and avoid security issues
                const getAssetUrl = (path) => {
                    // Construct absolute URL from root for GitHub Pages compatibility
                    const currentPath = window.location.pathname;
                    const basePath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '';
                    return `${window.location.origin}${basePath}/assets/duckdb-wasm/${path}`;
                };
                
                const bundles = {
                    mvp: {
                        mainModule: getAssetUrl("duckdb-mvp.wasm"),
                        mainWorker: getAssetUrl("duckdb-browser-mvp.worker.js")
                    },
                    eh: {
                        mainModule: getAssetUrl("duckdb-eh.wasm"),
                        mainWorker: getAssetUrl("duckdb-browser-eh.worker.js")
                    }
                };

                const bundle = await duckdb.selectBundle(bundles);
                // Create worker - URL should be same-origin to avoid security errors
                const worker = new Worker(bundle.mainWorker);
                const logger = new duckdb.ConsoleLogger();
                const db = new duckdb.AsyncDuckDB(logger, worker);
                await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                await db.open({
                    filesystem: {
                        forceFullHTTPReads: true
                    }
                });
                const connection = await db.connect();
                return { duckdb: db, connection };
            }

            if (atlasRoot && atlasStatus && !atlasRoot.dataset.initialized) {
                atlasRoot.dataset.initialized = "true";
                (async () => {
                    try {
                        atlasStatus.textContent = "Loading Embedding Atlas modules…";
                        
                        // Import modules using esm.sh which automatically resolves all dependencies
                        // The import map above provides fallback resolution for apache-arrow if needed
                        atlasStatus.textContent = "Loading embedding-atlas module…";
                        // Try importing from the dist folder which should have the proper build
                        const embeddingAtlasModule = await import("https://esm.sh/embedding-atlas@0.12.0/dist/index.js");
                        
                        // Log available exports for debugging
                        console.log("EmbeddingAtlas module exports:", Object.keys(embeddingAtlasModule));
                        console.log("Full module:", embeddingAtlasModule);
                        
                        // EmbeddingAtlas might be a default export or named export
                        let EmbeddingAtlas = embeddingAtlasModule.default || embeddingAtlasModule.EmbeddingAtlas;
                        
                        // If still not found, try the module itself (it might be the class directly)
                        if (!EmbeddingAtlas && typeof embeddingAtlasModule === 'function') {
                            EmbeddingAtlas = embeddingAtlasModule;
                        }
                        
                        // Check if it's a Svelte component (has mount method) or a regular class
                        if (EmbeddingAtlas && typeof EmbeddingAtlas === 'function') {
                            console.log("EmbeddingAtlas is a function/class");
                            console.log("EmbeddingAtlas.length (arity):", EmbeddingAtlas.length);
                            if (EmbeddingAtlas.prototype) {
                                console.log("EmbeddingAtlas has prototype");
                                console.log("EmbeddingAtlas.prototype methods:", Object.getOwnPropertyNames(EmbeddingAtlas.prototype));
                            }
                        }
                        
                        if (!EmbeddingAtlas) {
                            throw new Error("EmbeddingAtlas class not found in module. Available exports: " + Object.keys(embeddingAtlasModule).join(", "));
                        }
                        
                        console.log("EmbeddingAtlas type:", typeof EmbeddingAtlas);
                        console.log("EmbeddingAtlas:", EmbeddingAtlas);
                        
                        atlasStatus.textContent = "Loading mosaic-core module…";
                        const mosaicModule = await import("https://esm.sh/@uwdata/mosaic-core@0.21.1");
                        const Coordinator = mosaicModule.Coordinator;
                        const wasmConnector = mosaicModule.wasmConnector;

                        const coordinator = new Coordinator();
                        const duckdbResources = await createDuckDB();
                        const connector = wasmConnector({
                            duckdb: duckdbResources.duckdb,
                            connection: duckdbResources.connection
                        });
                        coordinator.databaseConnector(connector);

                        atlasStatus.textContent = "Downloading embeddings CSV…";
                        const response = await fetch(CSV_URL);
                        if (!response.ok) {
                            throw new Error("Dataset download failed");
                        }
                        const csvBuffer = new Uint8Array(await response.arrayBuffer());

                        atlasStatus.textContent = "Loading data into DuckDB…";
                        await duckdbResources.duckdb.registerFileBuffer(DATA_FILE, csvBuffer);

                        const createTableSQL = `
                            CREATE OR REPLACE TABLE maxvit_embeddings AS
                            SELECT
                                row_number() OVER () AS id,
                                CAST(umap_emb_1 AS DOUBLE) AS x,
                                CAST(umap_emb_2 AS DOUBLE) AS y,
                                source_set,
                                source_set_outlier,
                                fid,
                                field,
                                magpsf,
                                sigmapsf,
                                ra,
                                dec,
                                acai_h,
                                acai_v,
                                acai_o,
                                acai_n,
                                age,
                                days_since_peak,
                                days_to_peak,
                                near_threshold,
                                new_drb,
                                printf(
                                    'FID %d - Field %d - Mag %.2f - RA %.2f - Dec %.2f',
                                    CAST(fid AS INTEGER),
                                    CAST(field AS INTEGER),
                                    CAST(magpsf AS DOUBLE),
                                    CAST(ra AS DOUBLE),
                                    CAST(dec AS DOUBLE)
                                ) AS text
                            FROM read_csv_auto('${DATA_FILE}', header = true, sample_size = -1);
                        `;

                        await coordinator.exec(createTableSQL);

                        atlasStatus.textContent = "Rendering Embedding Atlas…";
                        
                        // Verify the container element exists and is valid
                        if (!atlasRoot) {
                            throw new Error("Container element 'embedding-atlas-root' not found");
                        }
                        if (!(atlasRoot instanceof HTMLElement)) {
                            throw new Error("Container element is not a valid DOM element");
                        }
                        
                        // Ensure the container is in the DOM
                        if (!atlasRoot.isConnected) {
                            throw new Error("Container element is not connected to the DOM");
                        }
                        
                        // Clear any existing content in the container
                        atlasRoot.innerHTML = '';
                        
                        // Debug: Log the container element to verify it's correct
                        console.log("Initializing EmbeddingAtlas with container:", atlasRoot);
                        console.log("Container type:", atlasRoot.constructor.name);
                        console.log("Container has appendChild:", typeof atlasRoot.appendChild);
                        console.log("Container nodeName:", atlasRoot.nodeName);
                        console.log("Container tagName:", atlasRoot.tagName);
                        
                        // Try creating a wrapper div if the container isn't a div
                        let targetElement = atlasRoot;
                        if (atlasRoot.tagName !== 'DIV') {
                            console.log("Container is not a DIV, creating wrapper");
                            const wrapper = document.createElement('div');
                            wrapper.style.width = '100%';
                            wrapper.style.height = '100%';
                            atlasRoot.appendChild(wrapper);
                            targetElement = wrapper;
                        }
                        
                        // Initialize EmbeddingAtlas
                        // Try different API formats - it might be a Svelte component or a regular class
                        console.log("Creating EmbeddingAtlas with target:", targetElement);
                        console.log("EmbeddingAtlas is:", EmbeddingAtlas);
                        console.log("EmbeddingAtlas prototype:", EmbeddingAtlas.prototype);
                        
                        let atlasInstance;
                        try {
                            // Try Svelte component API first (target and props)
                            console.log("Trying Svelte component API...");
                            atlasInstance = new EmbeddingAtlas({
                                target: targetElement,
                                props: {
                                    coordinator,
                                    data: {
                                        table: "maxvit_embeddings",
                                        id: "id",
                                        projection: { x: "x", y: "y" },
                                        text: "text",
                                        category: "source_set"
                                    },
                                    embeddingViewConfig: {
                                        colorScheme: "dark"
                                    },
                                    initialState: {
                                        colorBy: "source_set",
                                        showBottomMenu: false,
                                        displayMode: "density"
                                    }
                                }
                            });
                        } catch (svelteError) {
                            console.log("Svelte API failed, trying direct constructor...", svelteError);
                            // Try direct constructor with container as first argument
                            try {
                                atlasInstance = new EmbeddingAtlas(targetElement, {
                                    coordinator,
                                    data: {
                                        table: "maxvit_embeddings",
                                        id: "id",
                                        projection: { x: "x", y: "y" },
                                        text: "text",
                                        category: "source_set"
                                    },
                                    embeddingViewConfig: {
                                        colorScheme: "dark"
                                    },
                                    initialState: {
                                        colorBy: "source_set",
                                        showBottomMenu: false,
                                        displayMode: "density"
                                    }
                                });
                            } catch (directError) {
                                console.log("Direct constructor also failed, trying with just container...", directError);
                                // Try with just the container
                                atlasInstance = new EmbeddingAtlas(targetElement);
                            }
                        }
                        
                        console.log("EmbeddingAtlas instance created:", atlasInstance);

                        atlasStatus.remove();
                    } catch (error) {
                        console.error(error);
                        atlasStatus.textContent = `Embedding Atlas failed to load: ${error.message}`;
                        atlasStatus.classList.add("atlas-status-error");
                    }
                })();
            }
        </script>
    </body>
</html>

