<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-ZM95CLY1K3"
        ></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());
            gtag("config", "G-ZM95CLY1K3", {
                "anonymize_ip": true
            });
        </script>
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />
        <meta name="description" content="Visualization - Nabeel Rehemtulla" />
        <meta name="author" content="Nabeel Rehemtulla" />
        <title>Visualization - Nabeel Rehemtulla</title>
        <!-- Font Awesome icons (free version)-->
        <script
            src="https://use.fontawesome.com/releases/v5.15.1/js/all.js"
            crossorigin="anonymous"
        ></script>
        <!-- Google fonts-->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <!-- Core theme CSS-->
        <link href="css/styles.css" rel="stylesheet" />
        <!-- Import map to resolve ES module dependencies -->
        <script type="importmap">
        {
            "imports": {
                "apache-arrow": "https://esm.sh/apache-arrow@14.0.1"
            },
            "scopes": {
                "https://esm.sh/": {
                    "apache-arrow": "https://esm.sh/apache-arrow@14.0.1"
                },
                "https://cdn.jsdelivr.net/": {
                    "apache-arrow": "https://esm.sh/apache-arrow@14.0.1"
                }
            }
        }
        </script>
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar">
            <div class="nav-container">
                <a href="index.html" class="nav-logo">Nabeel Rehemtulla</a>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">About</a>
                    </li>
                    <li class="nav-item">
                        <a href="research.html" class="nav-link">Research</a>
                    </li>
                    <li class="nav-item">
                        <a href="visualization.html" class="nav-link active">Visualization</a>
                    </li>
                    <li class="nav-item">
                        <a href="assets/docs/NR_CV.pdf" target="_blank" class="nav-link">CV</a>
                    </li>
                </ul>
                <div class="nav-toggle" id="mobile-menu">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </div>
        </nav>

        <!-- Visualization Section -->
        <section class="page-section">
            <div class="container visualization-content">
                <h1>Visualization</h1>
                <p class="section-intro">
                    Explore the latest visualization work highlighting automated transient follow-up efforts. The embedded video below walks through the workflow and provides additional context on the tools powering these observations.
                </p>
                <div class="video-card">
                    <div class="video-wrapper">
                        <iframe
                            src="https://www.youtube-nocookie.com/embed/qUwlQflDdEo?si=AdulxxXQlIuAoBlf"
                            title="YouTube video player"
                            width="560"
                            height="315"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            referrerpolicy="strict-origin-when-cross-origin"
                            allowfullscreen
                            loading="lazy"
                        ></iframe>
                    </div>
                    <p class="video-caption">
                        This presentation captures how machine learning accelerates transient discovery and showcases the visualization pipeline in action.
                    </p>
                </div>
                <div class="atlas-card">
                    <div class="atlas-card-text">
                        <h2>Embedding Atlas Explorer</h2>
                        <p>
                            The chart below renders the <code>maxvit_gz_emb.csv</code> dataset (30k+ detections) directly in your browser using DuckDB-WASM +
                            Embedding Atlas. Pan, zoom, filter, and inspect individual sources without leaving the page.
                        </p>
                        <p class="atlas-tip">Tip: hover to preview tooltips, drag to lasso select regions, and toggle categories to compare survey subsets.</p>
                        <div id="embedding-atlas-status" class="atlas-status" role="status" aria-live="polite">
                            Initializing Embedding Atlas…
                        </div>
                    </div>
                    <div id="embedding-atlas-root" class="atlas-view" aria-label="Interactive embedding atlas workspace"></div>
                    <noscript class="atlas-noscript">
                        JavaScript is disabled, so the interactive Embedding Atlas cannot be displayed. Enable JavaScript to explore the embeddings.
                    </noscript>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <p>&copy; <span id="current-year"></span> Nabeel Rehemtulla</p>
            </div>
        </footer>

        <!-- Bootstrap core JS-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
        <script type="module">
            const atlasRoot = document.getElementById("embedding-atlas-root");
            const atlasStatus = document.getElementById("embedding-atlas-status");
            const DATA_FILE = "maxvit_gz_emb.csv";
            const CSV_URL = new URL(`./assets/dat/${DATA_FILE}`, window.location.href);
            const DUCKDB_VERSION = "1.30.0";

            async function createDuckDB() {
                const duckdb = await import(
                    `https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@${DUCKDB_VERSION}/dist/duckdb-browser.mjs`
                );

                // Use absolute paths from root to ensure same-origin and avoid security issues
                const getAssetUrl = (path) => {
                    // Construct absolute URL from root for GitHub Pages compatibility
                    const currentPath = window.location.pathname;
                    const basePath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '';
                    return `${window.location.origin}${basePath}/assets/duckdb-wasm/${path}`;
                };
                
                const bundles = {
                    mvp: {
                        mainModule: getAssetUrl("duckdb-mvp.wasm"),
                        mainWorker: getAssetUrl("duckdb-browser-mvp.worker.js")
                    },
                    eh: {
                        mainModule: getAssetUrl("duckdb-eh.wasm"),
                        mainWorker: getAssetUrl("duckdb-browser-eh.worker.js")
                    }
                };

                const bundle = await duckdb.selectBundle(bundles);
                // Create worker - URL should be same-origin to avoid security errors
                const worker = new Worker(bundle.mainWorker);
                const logger = new duckdb.ConsoleLogger();
                const db = new duckdb.AsyncDuckDB(logger, worker);
                await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                await db.open({
                    filesystem: {
                        forceFullHTTPReads: true
                    }
                });
                const connection = await db.connect();
                return { duckdb: db, connection };
            }

            if (atlasRoot && atlasStatus && !atlasRoot.dataset.initialized) {
                atlasRoot.dataset.initialized = "true";
                (async () => {
                    try {
                        atlasStatus.textContent = "Loading Embedding Atlas modules…";
                        
                        // Import modules using esm.sh which automatically resolves all dependencies
                        // The import map above provides fallback resolution for apache-arrow if needed
                        atlasStatus.textContent = "Loading embedding-atlas module…";
                        const embeddingAtlasModule = await import("https://esm.sh/embedding-atlas@0.12.0");
                        // EmbeddingAtlas might be a default export or named export
                        const EmbeddingAtlas = embeddingAtlasModule.default || embeddingAtlasModule.EmbeddingAtlas || embeddingAtlasModule;
                        
                        if (!EmbeddingAtlas) {
                            throw new Error("EmbeddingAtlas class not found in module. Available exports: " + Object.keys(embeddingAtlasModule).join(", "));
                        }
                        
                        atlasStatus.textContent = "Loading mosaic-core module…";
                        const mosaicModule = await import("https://esm.sh/@uwdata/mosaic-core@0.21.1");
                        const Coordinator = mosaicModule.Coordinator;
                        const wasmConnector = mosaicModule.wasmConnector;

                        const coordinator = new Coordinator();
                        const duckdbResources = await createDuckDB();
                        const connector = wasmConnector({
                            duckdb: duckdbResources.duckdb,
                            connection: duckdbResources.connection
                        });
                        coordinator.databaseConnector(connector);

                        atlasStatus.textContent = "Downloading embeddings CSV…";
                        const response = await fetch(CSV_URL);
                        if (!response.ok) {
                            throw new Error("Dataset download failed");
                        }
                        const csvBuffer = new Uint8Array(await response.arrayBuffer());

                        atlasStatus.textContent = "Loading data into DuckDB…";
                        await duckdbResources.duckdb.registerFileBuffer(DATA_FILE, csvBuffer);

                        const createTableSQL = `
                            CREATE OR REPLACE TABLE maxvit_embeddings AS
                            SELECT
                                row_number() OVER () AS id,
                                CAST(umap_emb_1 AS DOUBLE) AS x,
                                CAST(umap_emb_2 AS DOUBLE) AS y,
                                source_set,
                                source_set_outlier,
                                fid,
                                field,
                                magpsf,
                                sigmapsf,
                                ra,
                                dec,
                                acai_h,
                                acai_v,
                                acai_o,
                                acai_n,
                                age,
                                days_since_peak,
                                days_to_peak,
                                near_threshold,
                                new_drb,
                                printf(
                                    'FID %d - Field %d - Mag %.2f - RA %.2f - Dec %.2f',
                                    CAST(fid AS INTEGER),
                                    CAST(field AS INTEGER),
                                    CAST(magpsf AS DOUBLE),
                                    CAST(ra AS DOUBLE),
                                    CAST(dec AS DOUBLE)
                                ) AS text
                            FROM read_csv_auto('${DATA_FILE}', header = true, sample_size = -1);
                        `;

                        await coordinator.exec(createTableSQL);

                        atlasStatus.textContent = "Rendering Embedding Atlas…";
                        
                        // Verify the container element exists and is valid
                        if (!atlasRoot) {
                            throw new Error("Container element 'embedding-atlas-root' not found");
                        }
                        if (!(atlasRoot instanceof HTMLElement)) {
                            throw new Error("Container element is not a valid DOM element");
                        }
                        
                        // Ensure the container is in the DOM
                        if (!atlasRoot.isConnected) {
                            throw new Error("Container element is not connected to the DOM");
                        }
                        
                        // Initialize EmbeddingAtlas using Svelte component API
                        new EmbeddingAtlas({
                            target: atlasRoot,
                            props: {
                                coordinator,
                                data: {
                                    table: "maxvit_embeddings",
                                    id: "id",
                                    projection: { x: "x", y: "y" },
                                    text: "text",
                                    category: "source_set"
                                },
                                embeddingViewConfig: {
                                    colorScheme: "dark"
                                }
                            }
                        });

                        atlasStatus.remove();
                    } catch (error) {
                        console.error(error);
                        atlasStatus.textContent = `Embedding Atlas failed to load: ${error.message}`;
                        atlasStatus.classList.add("atlas-status-error");
                    }
                })();
            }
        </script>
    </body>
</html>

